# uploads/ai_image — структура и назначение

- tasks/ — задания на обработку (JSON)
- results/ — результаты обработки (JSON)
- originals/ — копии оригинальных изображений товаров
- processed/ — финальные сгенерированные изображения
- temp/ — временные файлы (ресайзы, промежуточные данные)
- templates/ — фоновые шаблоны для генерации
- logos/ — логотипы компании
- logs/ — логи работы WP и Python-частей
- archive/ — архив старых заданий и результатов
- config/ — конфиги и параметры (например, config.yaml)

---

## Пример задания (tasks/)
```json
{
  "task_id": "20240610T153000_abc12345",
  "type": "tyre",
  "original_image": "originals/tyre_123456.png",
  "template": "templates/tyre_template_v2.png",
  "icon": "logos/icon_sun.png",
  "product_data": {
    "brand": "Michelin",
    "model": "X-Ice North 4",
    "width": "205",
    "height": "55",
    "diameter": "R16",
    "load_index": "94",
    "speed_index": "T",
    "season": "зима",
    "studded": true
  },
  "output_filename": "processed/tyre_123456_ai.png",
  "created_at": "2024-06-10T15:30:00+03:00"
}
```

## Пример результата (results/)
```json
{
  "task_id": "20240610T153000_abc12345",
  "status": "success",
  "output_image": "processed/tyre_123456_ai.png",
  "log": "logs/20240610T153000_abc12345.log",
  "message": "OK",
  "started_at": "2024-06-10T15:31:00+03:00",
  "finished_at": "2024-06-10T15:31:20+03:00",
  "error": null
}
```

## Пример config.yaml
```yaml
tasks_dir: ../uploads/ai_image/tasks
results_dir: ../uploads/ai_image/results
originals_dir: ../uploads/ai_image/originals
processed_dir: ../uploads/ai_image/processed
templates_dir: ../uploads/ai_image/templates
logos_dir: ../uploads/ai_image/logos
logs_dir: ../uploads/ai_image/logs
batch_size: 10
max_image_size: 4096
log_level: INFO
```

## Пример лога (logs/plugin.log)
```
[2024-06-10 15:31:00] [INFO] Обработка задачи 20240610T153000_abc12345
[2024-06-10 15:31:20] [INFO] Результат задачи 20240610T153000_abc12345 сохранён
```

---

## Установка и настройка
1. Скопируйте структуру папок uploads/ai_image/ на сервер.
2. Убедитесь, что права на запись есть у веб-сервера и пользователя Python.
3. Настройте config.yaml под свои пути и параметры.
4. Установите зависимости Python из requirements.txt.
5. Проверьте работу интеграционного теста (py/test_integration.py).

## Эксплуатация
- Задания формируются через WP-плагин или вручную (tasks/).
- Python-скрипт обрабатывает задания, результаты появляются в results/ и processed/.
- Логи доступны в logs/.

## Восстановление
- Оригиналы изображений всегда хранятся в originals/ до успешной обработки.
- В случае сбоя можно повторно запустить обработку или восстановить оригинал вручную.
- Для очистки временных файлов используйте архивирование или удаление из temp/ и archive/.

## Крон и автоматизация

- В настройках WP-плагина (вкладка "Настройки") можно включить автоматическую обработку задач по расписанию (WP Cron).
- Чекбокс "Включить обработку по крону" — включает/выключает автоматический запуск обработки и обновления статусов.
- Поле "Время/интервал (минуты)" — задаёт частоту проверки и обработки очереди (по умолчанию 15 минут).
- При изменении этих настроек расписание пересоздаётся автоматически.
- Если крон выключен, автоматическая обработка не запускается, но можно запускать вручную через админку.

## Тестовые сценарии для автоматизации и крона

### Тест 1. Автоматическая обработка через WP Cron
1. Включите опцию "Включить обработку по крону" в настройках плагина.
2. Установите интервал (например, 1 минута).
3. Поместите тестовую задачу в очередь (tasks/).
4. Дождитесь срабатывания крона (или вызовите вручную через wp cron event run).
5. Проверьте, что:
   - В results/ появился результат с status=success.
   - В processed/ появилось итоговое изображение.
   - В мета-поле товара (_ai_image_processed) записан task_id.

### Тест 2. Отключение крона
1. Отключите опцию "Включить обработку по крону".
2. Поместите задачу в очередь.
3. Убедитесь, что через 2+ интервала задача не обработана автоматически.

### Тест 3. Пересоздание расписания
1. Включите крон, установите интервал 1 минута.
2. Измените интервал на 5 минут.
3. Проверьте, что событие пересоздано с новым интервалом (wp cron event list).

### Тест 4. Блокировка одновременного запуска
1. Запустите массовую обработку.
2. Попробуйте запустить одиночную обработку — убедитесь, что появляется сообщение о блокировке.

## Финальный пайплайн компиляции изображения
- Для каждого товара формируется задача с динамическими параметрами (цвета, шрифты, размеры, фон, иконка, данные товара).
- Основной объект (шина) вырезается с помощью AI, удаляется логотип (если есть), обрезаются пустые края.
- Все элементы (бренд, модель, характеристики, индексы, сезон, иконка, объект) размещаются адаптивно по макету.
- Итоговое изображение сохраняется в processed/.

### Пример задачи (tasks/)
```json
{
  "task_id": "20240610T153000_abc12345",
  "type": "tyre",
  "original_image": "originals/tyre_123456.png",
  "template": "templates/tyre_template_v2.png",
  "icon": "logos/icon_sun.png",
  "product_data": {
    "brand": "Michelin",
    "model": "X-Ice North 4",
    "width": "205",
    "height": "55",
    "diameter": "R16",
    "load_index": "94",
    "speed_index": "T",
    "season": "зима",
    "studded": true
  },
  "output_filename": "processed/tyre_123456_ai.png",
  "created_at": "2024-06-10T15:30:00+03:00",
  "params": {
    "font_bold": "Inter-Bold.ttf",
    "font_semibold": "Inter-SemiBold.ttf",
    "font_regular": "Inter-Regular.ttf",
    "color_white": "#FFFFFF",
    "color_black": "#222222",
    "color_cyan": "#23B2AA",
    "color_light_bg": "#F3F6F7",
    "color_load_idx_bg": "#30BBC2",
    "color_speed_idx_bg": "#357D9F",
    "width": 620,
    "height": 826,
    "logo_removal_method": "lama"
  }
}
```

### Особенности обработки основного объекта
- Вырезание шины с помощью rembg.
- Удаление логотипа (если требуется, по маске/шаблону).
- Обрезка пустых краёв по альфа-каналу.
- Гарантия, что на выходе — только шина, без лишних элементов.

## Автоматическое удаление логотипа с помощью U^2-Net
- Для удаления логотипа используется нейросеть U^2-Net (детектор салентных объектов).
- Крупнейший объект считается основной шиной, остальные — потенциальные логотипы и удаляются автоматически.
- Для работы требуется:
  1. Установить зависимости:
     pip install torch u2net
  2. Скачать веса модели (u2net.pth) отсюда: https://github.com/xuebinqin/U-2-Net/releases/download/v1.0/u2net.pth
  3. Положить файл u2net.pth рядом со скриптом или в рабочую папку.
- Если в задаче передана маска логотипа (logo_mask), используется она.
- Если маска не передана — используется автоматическая сегментация через U^2-Net.

## Весовые файлы U^2-Net для AI-обработки

Для работы автоудаления логотипа и выделения объектов требуется весовой файл U^2-Net:

- Скачать файл весов: [u2net.pth (Google Drive)](https://drive.google.com/file/d/1ao1ovG1Qtx4b7EoskHXmi2E9rp5CHLcZ/view?usp=sharing)
- Поместить скачанный файл в папку `py/` вашего проекта:
  - Окончательный путь: `py/u2net.pth`

После этого продвинутая AI-обработка изображений будет работать корректно.

## Новые параметры и сценарии (июнь 2024)

### Выбор метода удаления логотипа
- В настройках WP-плагина появился параметр "Метод удаления логотипа":
  - OpenCV (быстро, классический inpaint)
  - Lama Cleaner (AI-инпейтинг, качественно восстанавливает фон)
- Параметр передаётся в задачу как params.logo_removal_method ("opencv" или "lama").
- В Python-скрипте поддерживается выбор метода через этот параметр.

### Требования к Lama Cleaner
- Для работы AI-инпейнта требуется lama-cleaner:
  1. Установить: pip install lama-cleaner
  2. Для ускорения можно использовать GPU (опционально)
  3. Lama-cleaner вызывается автоматически через subprocess из Python-скрипта

### Debug-режим
- Если обработчик запущен с флагом --debug, сохраняются промежуточные файлы:
  - *_mask.png — итоговая маска логотипа
  - *_inpaint.png — результат удаления логотипа
  - *_nologo.png, *_crop.png — этапы обработки объекта
- Это помогает анализировать качество удаления логотипа и восстановления фона.

### Интеграционный тест удаления логотипа
- В py/test_integration.py реализован тест для двух методов (OpenCV и Lama):
  - Для каждого метода формируется задача, запускается обработка, проверяется результат.
  - Промежуточные файлы сохраняются для ручной проверки.

### Пример задачи с выбором метода удаления логотипа
```json
{
  "task_id": "20240610T153000_abc12345",
  ...
  "params": {
    ...
    "logo_removal_method": "lama"
  }
}
``` 