Подробный последовательный план работы проекта автоматизации AI-обработки изображений для WooCommerce, составленный на основе анализа всей документации и архитектуры кода.

---

## **1. Подготовка датасета и обучение моделей**

### 1.1. Сбор и разметка изображений
- Подбираются изображения товаров (шины, диски) с разными фонами, ракурсами, освещением.
- Разметка проводится в Roboflow:
  - Для YOLOv8: bounding box для логотипов/водяных знаков.
  - Для Instance Segmentation: маски объектов.
- Включаются как положительные (с логотипом), так и отрицательные примеры.
- Минимальный объём для теста — 10–20, для обучения — 100+ размеченных изображений.
- Датасет делится на train/val/test.

### 1.2. Экспорт и подготовка датасета
- Экспортируется в формате YOLOv8.
- Проверяется структура папок и корректность data.yaml.

### 1.3. Обучение моделей
- Обучается YOLOv8 для детекции логотипов/объектов.
- Обучается LaMa (или другая inpainting-модель) для восстановления изображения после удаления логотипа.
- Веса моделей сохраняются для инференса.

---

## **2. Архитектура и структура проекта**

### 2.1. Основные директории
- `plugins/ai-product-image/` — WordPress-плагин.
- `uploads/ai_image/` — обмен заданиями, логами, шаблонами, результатами:
  - `tasks/` — задания на обработку (JSON).
  - `results/` — результаты обработки (JSON).
  - `originals/` — исходные изображения.
  - `processed/` — финальные картинки.
  - `temp/` — временные файлы.
  - `templates/` — шаблоны фонов.
  - `logos/` — логотипы.
  - `logs/` — логи работы.
  - `archive/` — архив заданий и результатов.
  - `config/` — конфиги и параметры.
- `py/` — Python-скрипты и venv.

---

## **3. Основной пайплайн обработки**

### 3.1. Формирование задания (WordPress)
- Админ выбирает товары для обработки (по крону, вручную, массово).
- Для каждого товара формируется JSON-задание (task) с параметрами:
  - Путь к оригиналу, шаблону, логотипу.
  - Данные о товаре (бренд, модель, характеристики).
  - Путь для сохранения результата.

### 3.2. Обработка задания (Python)
- Скрипт читает задания из `tasks/`, валидирует их.
- Для каждого задания:
  1. **Детекция объектов (YOLOv8):**
     - Находит логотипы и саму шину/диск.
     - Генерирует маски.
  2. **Удаление логотипа (LaMa):**
     - По маске логотипа восстанавливает изображение.
  3. **Удаление фона (rembg/U^2-Net):**
     - Обрезает фон по маске шины/диска.
  4. **Постобработка:**
     - Обрезка по минимальному bbox.
     - Выровнять, центрировать, ресайзить до стандарта (например, 321x482).
  5. **Финальная сборка:**
     - Размещение объекта на шаблонном фоне.
     - Добавление текстовой информации (бренд, модель, характеристики).
     - Добавление логотипа компании.
  6. **Сохранение результата:**
     - Финальное изображение сохраняется в `processed/`.
     - В `results/` пишется JSON с результатом, статусом, логом.

### 3.3. Логирование и мониторинг
- Каждый этап логируется (отдельный лог на задание и общий лог системы).
- Ведётся ротация и очистка логов.
- Возможен анализ состояния очереди и ошибок.

---

## **4. Интеграция с WordPress**

### 4.1. Плагин WordPress
- UI для управления заданиями, просмотром результатов, настройками.
- Передача параметров в задания (фон, иконки, логотип, шрифты, цвета).
- Интеграция с WP Cron для автоматизации.
- Валидация данных, защита CSRF, проверка прав.

### 4.2. Получение и отображение результатов
- Плагин отслеживает появление новых результатов в `results/`.
- Автоматически обновляет изображения товаров в WooCommerce.

---

## **5. Документирование и эксплуатация**

- Описан процесс установки, настройки, эксплуатации и восстановления.
- Примеры конфигов, логов, шаблонов.
- Все процессы снабжены тестами и rollback-механизмами.
- README и документация поддерживаются в актуальном состоянии.

---

## **6. Механизмы отказоустойчивости и восстановления**

- Автоматическое восстановление зависших задач.
- Очистка устаревших/некорректных данных.
- Перезапуск обработки после сбоев.
- Синхронизация состояния очереди и результатов.

---

## **7. Масштабирование и расширяемость**

- Пакетная обработка (batch), лимиты на размер и количество изображений.
- Лёгкое добавление новых типов шаблонов, фонов, параметров.
- Возможность расширения под новые сценарии (например, новые категории товаров).

---

## **8. Краткая схема этапов (алгоритм)**

1. **Сбор и разметка датасета** → 2. **Обучение моделей** → 3. **Формирование задания** → 4. **Детекция и маскирование** → 5. **Удаление логотипа и фона** → 6. **Постобработка и компоновка** → 7. **Сохранение результата** → 8. **Обновление товара в WooCommerce** → 9. **Логирование и мониторинг**.

---

## Краткое описание последующей задачи
- Клонировать проект `ai-product-image-project` для создания новой версии с удалением части функционала и доработкой оставшегося.
- Организовать новый git-репозиторий для основного проекта.

## Ключевые решения и рекомендации
- Новый проект вести в отдельной папке и отдельном git-репозитории.
- Все изменения (удаление, доработка) фиксировать отдельными коммитами.
- Вести README и документацию по новой структуре и изменениям.

## Выполненные шаги
- Подготовлен пошаговый план по клонированию и инициализации нового проекта.

## Следующие шаги
1. Копировать корневую папку проекта (`ai-product-image-project`) в новую директорию (например, `ai-product-image-project-new`).
2. Открыть новую папку как отдельный проект в редакторе.
3. Инициализировать новый git-репозиторий и сделать первый коммит.
4. Удалить ненужные функциональные блоки, зафиксировать изменения коммитом.
5. Внести необходимые доработки в оставшийся функционал, фиксировать отдельными коммитами.
6. Обновить/добавить документацию (README, описание структуры, инструкции по запуску).
7. Провести тестирование и сделать финальный push.

## Важные детали из переписки
- Все рекомендации и архитектурные решения согласованы с учётом масштабируемости, поддержки и удобства интеграции.
- Для передачи контекста в новый проект этот файл можно использовать как вводную для ассистента или команды. 