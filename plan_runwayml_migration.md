# План перехода на использование runwayml.com для поиска, удаления логотипа и восстановления объекта

## 1. Изменения в WordPress-плагине

### 1.1. Хранение API-ключа RunwayML
- Добавить новое поле в настройки плагина (admin-page.php):
  - Тип: текстовое поле для ввода API-ключа RunwayML.
  - Сохранять в базе данных через register_setting (class-settings.php):
    - `register_setting('ai_image_settings', 'ai_image_runwayml_api_key');`
- Валидация и защита ключа (например, скрывать при отображении).

### 1.2. Выбор метода удаления логотипа
- В настройках плагина (admin-page.php) добавить новый вариант:
  - В выпадающем списке "Метод удаления логотипа" добавить:
    - `runwayml` — RunwayML API (облако)
- Везде, где формируется задача (class-task-manager.php), передавать выбранный метод в params.logo_removal_method.
- При выборе runwayml — также передавать params.runwayml_api_key (брать из настроек).

## 2. Изменения в Python-скриптах

### 2.1. Новый метод удаления логотипа
- В py/ai_image_processor.py реализовать функцию:
  - `def remove_logo_runwayml(img, prompt, api_key, debug_path_prefix=None):`
    - Отправляет изображение и промпт на runwayml.com через API.
    - Получает изображение без логотипа.
    - Логирует этапы, ошибки, параметры запроса и ответа.
    - Обрабатывает ошибки API (таймауты, 4xx/5xx, некорректный ответ, отсутствие результата).
    - В случае ошибки — логирует и выбрасывает исключение с подробностями.

### 2.2. Интеграция нового метода в пайплайн
- В функции remove_logo_from_object добавить ветку:
  - Если logo_removal_method == 'runwayml':
    - Получить prompt (можно формировать динамически, например, "Find and remove the logo/watermark from the image, restore the main object (tire or wheel) as realistically as possible.")
    - Получить api_key из params (task['params']['runwayml_api_key'])
    - Вызвать remove_logo_runwayml
    - Вернуть результат
- В process_image добавить логирование выбранного метода и ключевых этапов.

### 2.3. Логирование
- Использовать logger.info/debug/error на каждом этапе:
  - Перед отправкой запроса в runwayml
  - После получения ответа
  - При ошибках (с деталями)
  - На всех ключевых этапах пайплайна (удаление логотипа, удаление фона, обрезка, компоновка, сохранение)
- В случае debug_logging=True — сохранять промежуточные файлы (input, output, response dump).

### 2.4. Обработка ошибок
- В функции remove_logo_runwayml:
  - try/except вокруг запроса
  - Логировать код ответа, текст ошибки, тело ответа
  - В случае ошибки — возвращать None или выбрасывать исключение, чтобы пайплайн мог корректно обработать сбой (например, записать ошибку в result_json)
- В process_image — если этап runwayml завершился с ошибкой, логировать и корректно завершать задачу (не падать без сообщения).

## 3. Документация и тесты
- Обновить README.md и документацию по настройке API-ключа и выбору метода.
- Добавить интеграционный тест для runwayml (py/test_integration.py):
  - Проверить успешный сценарий и обработку ошибок.

## 4. Удаление устаревших методов (по желанию)
- После успешной интеграции runwayml можно удалить/закомментировать старые методы (lama, opencv) или оставить для fallback.

---

**Примечание:**
- Вся логика выбора метода удаления логотипа уже реализована через параметр logo_removal_method (WP → params → Python).
- Логирование в Python уже реализовано через logger.info/debug/error, требуется только добавить новые сообщения для runwayml.
- Класс Logger для плагина уже есть (class-logger.php), используется для записи действий и ошибок. 