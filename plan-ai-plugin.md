# План и инструкция по разработке AI-плагина и Python-скриптов для WooCommerce

## Общие положения и архитектурные принципы

- Модульность, расширяемость, простота поддержки.
- Все изменения должны быть откатываемы, логироваться, снабжаться тестами и описанием.
- Строго придерживаться стандартов кодирования WordPress и Python.
- Использовать исключительно внутренние директории плагина в uploads/ai_image/.
- Каждый этап пайплайна (создание задания, обработка, выдача результата) должен быть прозрачно логирован и легко мониториться.
- Любые ошибки и сбои фиксируются и не блокируют выполнение других задач.
- Все входные данные валидируются и логируются.
- Взаимодействие между компонентами только в пределах доверенной инфраструктуры.
- Пакетная обработка (batch): не более N товаров за раз (N настраивается).
- Лимитировать размер изображений и их число в одной задаче.
- Код плагина совместим с последними версиями WordPress и WooCommerce, использует стандарты WordPress.
- Python-скрипты совместимы с Python 3.10+.
- Любое изменение сопровождается описанием цели, внесённых изменений и тестовым сценарием.
- Хранить исходные изображения и промежуточные файлы до успешного завершения задачи.
- Предусмотреть возможность ручного или автоматического восстановления при сбоях.

---

## Цель проекта

Создать полностью автоматизированную и расширяемую систему для генерации и подмены изображений товаров в WooCommerce с помощью AI, состоящую из WordPress-плагина и Python-скриптов. Система должна:
- Формировать шаблонные изображения товаров с выделением объекта, фирменным фоном и текстовыми метками.
- Массово и автоматически обрабатывать большие выборки товаров.
- Позволять управлять процессом из админки WordPress.
- Быть легко разворачиваемой и поддерживаемой на ограниченном хостинге.

---

## Структура директорий

```
ai_image/
├── tasks/           # Задания на обработку
├── results/         # Готовые результаты
├── originals/       # Оригиналы изображений
├── processed/       # Финальные картинки
├── temp/            # Временные файлы
├── templates/       # Фоновые шаблоны
├── logos/           # Логотипы компании
├── logs/            # Логи работы
├── archive/         # Старые задания и результаты
├── config/          # Конфиги и параметры
└── readme.md        # Техническая документация
```

---

## Форматы очереди (задания и результаты)

### Пример задания (tasks/)
```json
{
  "task_id": "20240610T153000_abc12345",
  "type": "tyre",
  "original_image": "originals/tyre_123456.png",
  "template": "templates/tyre_template_v2.png",
  "logo": "logos/company_logo.png",
  "product_data": {
    "brand": "Michelin",
    "model": "X-Ice North 4",
    "width": "205",
    "height": "55",
    "diameter": "R16",
    "load_index": "94",
    "speed_index": "T",
    "season": "зима",
    "studded": true
  },
  "output_filename": "processed/tyre_123456_ai.png",
  "created_at": "2024-06-10T15:30:00+03:00"
}
```

### Пример результата (results/)
```json
{
  "task_id": "20240610T153000_abc12345",
  "status": "success",
  "output_image": "processed/tyre_123456_ai.png",
  "log": "logs/20240610T153000_abc12345.log",
  "message": "OK",
  "started_at": "2024-06-10T15:31:00+03:00",
  "finished_at": "2024-06-10T15:31:20+03:00",
  "error": null
}
```

---

## Этапы реализации (чек-лист)

### 0. Создание структуры директорий проекта (дополнение)

- [x] Создать базовые директории для плагина, обмена заданиями и Python-скриптов

Перед началом реализации необходимо создать базовые директории:
- plugins/ai-product-image/ — для файлов WordPress-плагина
- uploads/ai_image/ — для обмена заданиями, логов, шаблонов и результатов
  - uploads/ai_image/tasks/
  - uploads/ai_image/results/
  - uploads/ai_image/originals/
  - uploads/ai_image/processed/
  - uploads/ai_image/temp/
  - uploads/ai_image/templates/
  - uploads/ai_image/logos/
  - uploads/ai_image/logs/
  - uploads/ai_image/archive/
  - uploads/ai_image/config/
  - uploads/ai_image/readme.md
- py/ — для Python-скриптов и виртуального окружения

После создания структуры приступить к реализации этапов 1–5.

### 1. Проектирование интерфейса взаимодействия
- [x] Выбрать способ обмена заданиями: файловый обмен или REST API (если возможно)
- [x] Описать формат задачи и результата (JSON)
- [x] Настроить структуру директорий

### 2. Разработка WordPress-плагина
- [x] Создать директорию includes для классов плагина
- [x] Оформить как полноценный плагин с мета-информацией
- [x] Создать основной класс плагина (AI_Product_Image_Plugin)
- [x] Создать директории admin, assets, assets/css, assets/js, languages
- [x] Реализовать базовый UI для управления задачами и настройками (страница в админке)
- [x] Создать класс Task Manager для управления заданиями (tasks/)
- [x] Реализовать форму создания новой задачи в админке
- [x] Реализовать отображение результатов обработки (results/) в админке
- [x] Интегрировать с cron для автоматизации (WP Cron, поддержка системного cron через wp-cron.php)
- [x] Реализовать логирование (класс Logger, ротация логов, запись действий и ошибок)
- [x] Реализовать резервное копирование оригиналов изображений (originals/)
- [x] Реализовать базовую валидацию данных задачи
- [x] Проверка прав доступа и CSRF-защита в админке
- [x] Реализовать расширенные настройки плагина:
    - [x] UI для загрузки и выбора фонов (лето, зима, всесезон), иконок (лето, зима, любой сезон), логотипа, шрифтов.
    - [x] UI для задания цветов, размеров, путей к шрифтам.
    - [x] Сохранение всех параметров в опциях WP.
    - [x] Передача параметров в Python-скрипт через задачу или отдельный конфиг.

- [x] Реализовать фильтрацию товаров по категориям (ID 14834 и её потомки) для массовой и одиночной обработки.

- [x] Реализовать страницу запуска обработки:
    - [x] Одиночная обработка: ввод ID товара, запуск, проверка, чекбокс "повторная обработка", уведомления.
    - [x] Массовая обработка: запуск/остановка, прогресс, лимит по количеству, обработка батчами.
    - [x] Блокировка одновременного запуска любых двух обработок.

- [x] Реализовать управление запуском по крону:
    - [x] Чекбокс "Включить обработку по крону".
    - [x] Настройка времени срабатывания крона (интервал в минутах).
    - [x] Пересоздание расписания при изменении настроек.
    - [x] Проверка блокировки (не запускать, если уже идёт обработка).

### 3. Разработка Python-скриптов
- [x] Создать директорию py для Python-скриптов и виртуального окружения
- [x] Создать requirements.txt с зависимостями (rembg, pillow, pyyaml, jsonschema, loguru)
- [x] Реализовать заготовку основного скрипта обработки (ai_image_processor.py)
- [x] Реализовать config.yaml и чтение параметров
- [x] Реализовать batch-обработку задач
- [x] Реализовать валидацию входных данных через jsonschema
- [x] Реализовать обработку изображений (rembg, Pillow), логирование ошибок и этапов, сохранение результата
- [x] Принимать и использовать параметры из настроек WP (фон, иконки, логотип, шрифты, цвета, размеры).
- [x] Вырезать шину из исходной картинки, удалять логотип, обрезать пустые края.
- [x] Адаптивно позиционировать и масштабировать шину на фоне.
- [x] Использовать разные фоны и иконки в зависимости от сезона (лето, зима, всесезон).
- [x] Генерировать итоговое изображение по расширенному сценарию (см. пример кода).
- [x] Логировать этапы обработки, ошибки, сохранять результат.
- [x] Реализовать финальный адаптивный скрипт компоновки изображения:
    - [x] Все параметры (пути, цвета, шрифты, размеры, иконки, фон, логотип, данные товара) берутся из задачи и настроек.
    - [x] Вырезание основного объекта (шины) с удалением логотипа и обрезкой пустых краёв.
    - [x] Адаптивная отрисовка всех элементов (бренд, модель, характеристики, индексы, сезон, иконка, логотип, объект).
    - [x] Поддержка динамических данных и расширенных сценариев.

- [x] Доработать Python-скрипт для поддержки разных методов удаления логотипа

### 4. Интеграция и тестирование
- [x] Настроить обмен файлами между WP и Python (структура и формат очереди реализованы)
- [x] Провести тестовую обработку партии задач (через интеграционный тест)
- [x] Проверить корректность логирования, отката и очистки (анализ логов, статусов, файлов)
- [x] Подготовить интеграционный тест для пайплайна (test_integration.py)
- [~] Добавить тесты для новых сценариев (разные сезоны, разные параметры, массовая и одиночная обработка, блокировки).

### 5. Документирование и эксплуатация
- [x] Описать процесс установки и настройки
- [x] Описать процесс эксплуатации и восстановления
- [x] Приложить примеры конфигов, логов и шаблонов
- [x] Описать новые настройки, примеры конфигов, сценарии использования.

### Описание этапа Python-обработки (финальная компиляция)
- Используется адаптивный скрипт, реализующий компоновку изображения по всем требованиям (см. раздел "Финальный сценарий").
- Все параметры и данные берутся из задачи (task.json) и/или настроек WP.
- Основной объект (шина) вырезается с удалением логотипа и обрезкой пустых краёв.
- Все элементы (текст, иконки, логотип, объект) размещаются адаптивно по макету.

---

## Требования к коду

- WordPress-плагин реализуется по WP Coding Standards (отступы, имена, безопасность, документирование).
- Python-скрипты в виртуальном окружении, зависимости фиксируются в requirements.txt, параметры в config.yaml.
- Для взаимодействия между WP и Python используется только файловый обмен (tasks/results), никаких внешних API.
- Все процессы должны быть документированы, протестированы, снабжены откатами и мониторингом.

---

## Примечания

- После выполнения каждого пункта отмечать его галочкой.
- При необходимости расширять план новыми этапами и подпунктами.
- Все изменения и дополнения фиксировать в этом файле.

---

## Дополнительно: Требования к оформлению кода и поддержке

- Для PHP:
  - Использовать PHPDoc для всех функций и классов.
  - Соблюдать стандарты именования: PascalCase для классов, snake_case для функций и переменных, UPPER_CASE для констант, префиксы функций и классов (например, ai_image_).
- Для Python:
  - Использовать docstring для всех функций и классов.
  - Применять типизацию (type hints) для аргументов и возвращаемых значений.
  - Структурировать проект с использованием venv, requirements.txt, config.yaml.

---

## Механизм ротации и хранения логов

- Логи хранятся не более X дней (например, 30) или до достижения Y МБ (например, 100 МБ).
- Реализовать автоматическую очистку/архивацию старых логов (скрипт или cron).
- Вести отдельные логи для каждого задания и общий лог системы.

---

## Мониторинг и диагностика

- Реализовать отдельный скрипт или раздел для анализа логов и состояния очереди.
- Вести мониторинг состояния системы, ошибок, времени выполнения задач.
- Предусмотреть возможность просмотра статистики обработки и отчётов через админку или отдельный файл.

---

## Механизмы восстановления

- Автоматические:
  - Восстановление зависших задач (например, по таймауту или статусу).
  - Очистка устаревших или некорректных данных.
  - Перезапуск обработки после сбоев.
  - Синхронизация состояния очереди и результатов.
- Ручные:
  - Сброс временных данных и очереди задач через админку или отдельный скрипт.
  - Восстановление из резервных копий оригинальных изображений и результатов.
  - Ручной перезапуск обработки для отдельных задач.

---

## Документирование и README.md

- В корне директории ai_image/ должен быть README.md с:
  - Описанием структуры директорий и файлов.
  - Примерами типовых конфигов (config.yaml, JSON задач и результатов).
  - Примерами логов и шаблонов изображений.
  - Инструкцией по установке, настройке и эксплуатации.
  - Описанием механизмов восстановления и мониторинга.

---

## Тестирование

- Для Python-скриптов:
  - Обязательное наличие unit-тестов (например, с использованием pytest или unittest).
  - Интеграционные тесты для проверки пайплайна обработки задач.
- Для WordPress-плагина:
  - Тестовые сценарии для проверки создания задач, обработки результатов, отката и восстановления.
  - Проверка UI, cron-обработки, логирования и безопасности.

### Описание механизма автоматизации (WP Cron)
- В настройках плагина можно включить/выключить автоматическую обработку задач по расписанию.
- Интервал задаётся в минутах, расписание пересоздаётся автоматически при изменении опций.
- Если крон выключен, автоматическая обработка не запускается, но доступна ручная обработка через админку.

---

## Внедрение выбора метода удаления логотипа (OpenCV/Lama) и улучшение пайплайна

- [x] Добавить параметр выбора метода удаления логотипа в настройки WP-плагина (OpenCV/Lama)
- [x] Сохранять выбранный метод в опциях WP и передавать в задачу
- [x] Доработать Python-скрипт для поддержки разных методов удаления логотипа
- [x] Интегрировать lama-cleaner (через pip или subprocess)
- [x] Сохранять маску логотипа и промежуточные результаты удаления (debug)
- [x] Логировать этапы удаления логотипа и выбранный метод
- [x] Добавить интеграционный тест на удаление логотипа с восстановлением
- [x] Обновить README.md и документацию по новым параметрам

## Вариант: Восстановление шины под логотипом через inpaint только по шине

- Вместо обычного inpaint по всей области логотипа, применяется inpaint только к тем пикселям, которые принадлежат шине и были закрыты логотипом.
- Это позволяет восстанавливать структуру шины, а не фона, и минимизировать артефакты.
- В коде реализовано через ALT_TIRE_INPAINT = True/False (можно легко откатить).
- Если вариант будет утверждён, он может быть включён в основной пайплайн.

---

# LAMA_API_PATCH (2024-06-21)

- Интегрирован вызов lama-cleaner через HTTP API (серверный режим, POST /inpaint) для автоматизации AI-инпейнта.
- Старый способ через subprocess оставлен закомментированным в коде (py/ai_image_processor.py, функция remove_logo_lama) для быстрого отката.
- Для возврата к subprocess-вызову: раскомментировать старый блок и закомментировать новый.
- Все изменения помечены в коде комментарием # LAMA_API_PATCH.
- Для работы требуется запущенный lama-cleaner сервер на http://127.0.0.1:8080. 